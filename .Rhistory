install.packages("easypackages")
#explanatory variables
var.list <- c("Married","AttendenceEvent","FY15Giving.Grouped","Major.Donation.Level","Adv.Deg","Gender","FY14Giving.Grouped","FY13Giving.Grouped","FY12Giving.Grouped")
pred.list<-c("[0-1)","[1-100)","[100-250)","[250-500)","[500-200000)" )
newData <- unique(givings[,var.list])
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
library(knitr)
library(vcd)
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
library(Hmisc)
library(ggplot2)
library(dplyr)
library(GGally)
library(data.table)
library(stargazer)
library(tidyverse)
library(forcats)
library(scales)
library(gridExtra)
library(reshape)
library(ordinal)
library(car)
givings = read.csv("./lab2data.csv")
str(givings)
sum(is.na(givings))
levels(givings$Gender)  = c("Female", "Male")
givings$AttendenceEvent = factor(givings$AttendenceEvent, levels = c(0,1),
labels = c("Didn't Attend", "Attended"))
levels(givings$Marital.Status) = c("Divorced", "Married", "Single", "Widowed")
givings$Class.Year = factor(givings$Class.Year)
givings$FY12Giving = as.numeric(givings$FY12Giving)
givings$FY13Giving = as.numeric(givings$FY13Giving)
givings$FY14Giving = as.numeric(givings$FY14Giving)
givings$FY15Giving = as.numeric(givings$FY15Giving)
givings$FY16Giving = as.numeric(givings$FY16Giving)
givings$FY12Giving.Grouped <- factor(cut(givings$FY12Giving, breaks=c(0,1,100,250,500, 200000), labels=c("[0-1)", "[1-100)", "[100-250)","[250-500)","[500-200000)"), right = FALSE))
givings$FY13Giving.Grouped <- factor(cut(givings$FY13Giving, breaks=c(0,1,100,250,500, 200000), labels=c("[0-1)", "[1-100)", "[100-250)","[250-500)","[500-200000)"), right = FALSE))
givings$FY14Giving.Grouped <- factor(cut(givings$FY14Giving, breaks=c(0,1,100,250,500, 200000), labels=c("[0-1)", "[1-100)", "[100-250)","[250-500)","[500-200000)"), right = FALSE))
givings$FY15Giving.Grouped <- factor(cut(givings$FY15Giving, breaks=c(0,1,100,250,500, 200000), labels=c("[0-1)", "[1-100)", "[100-250)","[250-500)","[500-200000)"), right = FALSE))
givings$FY16Giving.Grouped <- factor(cut(givings$FY16Giving, breaks=c(0,1,100,250,500, 200000), labels=c("[0-1)", "[1-100)", "[100-250)","[250-500)","[500-200000)"), right = FALSE))
givings.tidy.donations <- givings[1:12] %>% gather("Giving.Year", "Donations", 8:12)
givings.tidy.donations$Giving.Grouped <- factor(cut(givings.tidy.donations$Donations, breaks=c(0,1,100,250,500, 200000),
labels=c("[0-1)", "[1-100)", "[100-250)","[250-500)","[500-200000)"), right = FALSE))
givings.tidy.donations.aggregate <- as.data.frame(xtabs(~ Giving.Grouped + Giving.Year, data = givings.tidy.donations))
p1 <- ggplot(givings.tidy.donations, aes(x=Donations, colour=Giving.Year)) +
geom_density(alpha=0.3) +
labs(title = "Density plot for contributions") +
theme_bw()
p2 <- ggplot(givings.tidy.donations, aes(x=Donations, colour=Giving.Year)) +
geom_density(alpha=0.3) +
scale_x_continuous(breaks=c(0,1,100,250,500,200000),trans="log1p", expand=c(0,0)) +
labs(title = "Log scale density plot for contributions") +
scale_y_continuous() +
theme_bw()
p3 <- ggplot(givings.tidy.donations.aggregate, aes(x = Giving.Grouped, y=Freq)) +
geom_bar(aes(fill = Giving.Year ), stat = 'identity', position = 'dodge') +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(y = "Donations", x= "Brackets", title = "Contributions over years") +
theme_bw()
grid.arrange(p1, p2,p3, ncol=1, nrow=3)
row <- xtabs( ~ Gender, data = givings)
data.frame(rbind(row,row/dim(givings)[1]), row.names = c("Donor Count", "Ratio"))
row <- xtabs( ~ Class.Year, data = givings)
data.frame(rbind(row,row/dim(givings)[1]), row.names = c("Class.Year Count", "Ratio"))
row <- xtabs( ~ Marital.Status, data = givings)
data.frame(rbind(row,row/dim(givings)[1]), row.names = c("Marital.Status Count", "Ratio"))
ggplot(givings, aes(x = Major)) + geom_histogram(stat ="count") + labs(title = "Count for each Major", x = "Various Majors") +
theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
head(sort(xtabs( ~ Major, data = givings)),3)
ggplot(givings, aes(x = Next.Degree)) + geom_histogram(stat ="count") + labs(title = "Count for each Next.Degree", x = "Various Degrees") +
theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
givings$Adv.Deg <-fct_collapse(givings$Next.Degree,
bachelor_equivalent = c("AA","BA","BAE","BD","BFA","BN","BS","BSN","LLB","LLD","NDA","UBDS","UDDS","UMD","UMDS","UNKD","TC"),
above_bachelor= c("DC","DDS","DMD","DO","DO2","DP","JD","PHD","MA","MA2","MAE","MALS","MAT","MBA","MCP","MD","MD2","ME", "MFA","MHA","ML","MLS","MM","MPA","MPH","MS","MSM","MSW","STM"))
row <- xtabs( ~ AttendenceEvent, data = givings)
data.frame(rbind(row,row/dim(givings)[1]), row.names = c("AttendenceEvent Count", "Ratio"))
t1 <- xtabs(~ Gender + FY16Giving.Grouped , data = givings)
t1.1 <-round(t1/rowSums(t1),2)
#kable(list(t1, t1.1), caption = "Frequency vs. Ratio for FY16Giving.Grouped vs. Gender")
t1
t1.1
t2 <- xtabs(~ Class.Year + FY16Giving.Grouped , data = givings)
t2.1 <- round(t2/rowSums(t2),2)
#kable(list(t2,t2.1), caption = "Frequency and Ratio for FY16Giving.Grouped vs. Class.Year")
t2
t2.1
t3 <- xtabs(~ Marital.Status + FY16Giving.Grouped, data = givings)
t3.1 <- round(t3/rowSums(t3),2)
#kable(list(t3,t3.1), caption = "Frequency and Ratio for FY16Giving.Grouped vs. Marital.Status")
t3
t3.1
givings$Last.4Year.Avg<- rowMeans(givings[c("FY12Giving","FY13Giving","FY14Giving","FY15Giving")])
Major.Index<-data.frame(aggregate(Last.4Year.Avg ~ Major, data = givings,median))
ggplot(Major.Index, aes(Last.4Year.Avg))+geom_histogram(bins=30)
givings<-merge(x = givings, y = Major.Index, by = "Major")
givings$Major.Donation.Level<-factor(cut(givings$Last.4Year.Avg.y,
labels = c("NO","Low","Medium","High"),breaks=c(0,1,10,30,200000),  right = FALSE))
t18 <-xtabs(~Major.Donation.Level+FY16Giving.Grouped, data=givings)
round(t18/rowSums(t18),2)
givings$High.Donor.Major <- ifelse(givings$Major %in% c("History","Psychology","Biology", "Economics"),TRUE,FALSE)
t12<-xtabs(~Adv.Deg+FY16Giving.Grouped, data= givings)
round(t12/rowSums(t12),2)
(t4 <- xtabs(~ AttendenceEvent + FY16Giving.Grouped , data = givings))
FY_analysis <- function(x,y){
groups<-aggregate(givings$FY16Giving.Grouped, by=list(givings[,x],givings[,y],givings$FY16Giving.Grouped),"length")
colnames(groups)<-c("x","y","FY16Giving.Grouped","cnt")
#head(groups15_14)
groups_cast<-cast(groups,x+y ~ FY16Giving.Grouped,value = 'cnt')
colnames(groups_cast)[c(1,2)]<-c("x","y")
output<- cbind(groups_cast[,c(1,2)],groups_cast[,c(3,4,5,6,7)]/rowSums(groups_cast[,c(3,4,5,6,7)],na.rm = TRUE))
output[is.na(output)] <- 0
return(output)}
output<-FY_analysis("FY15Giving.Grouped","FY14Giving.Grouped")
melt_output<-melt(output,id=c("x","y"))
levels(melt_output[,1])<- c(0,1,100,250,500)
melt_output[,1]<-as.numeric(levels(melt_output[,1]))[melt_output[,1]]
ggplot(melt_output, aes(x,value,colour=y,linetype=variable))+geom_line(lwd=1)+theme_bw()+ggtitle(paste("FY15Giving.Grouped"," vs ","FY14Giving.Grouped"))+ylab("Actual probability")+scale_linetype_manual(values=c("solid","twodash","longdash","12345678","dotted"))+scale_color_manual(values=c("red","orange","blue","green","purple"))+guides(color=guide_legend(title="FY16Giving.Grouped"),linetype=guide_legend(title="FY16Giving.Grouped"))
colnames(output)[1:2]<-c("FY15Giving.Grouped","FY14Giving.Grouped")
head(cbind(output[,1:2],round(output[,3:7],2)),4)
xtabs(~ FY16Giving.Grouped + FY12Giving.Grouped, data = givings)
xtabs(~ FY16Giving.Grouped + FY13Giving.Grouped, data = givings)
xtabs(~ FY16Giving.Grouped + FY14Giving.Grouped, data = givings)
xtabs(~ FY16Giving.Grouped + FY15Giving.Grouped, data = givings)
t6 <- xtabs(~ Class.Year + Gender, data = givings)
t(t6)
t(round(t6/rowSums(t6),2))
t7 <- xtabs(~ Marital.Status + Gender, data = givings)
t(t7)
t(round(t7/rowSums(t7),2))
t8 <- xtabs(~  Major.Donation.Level + Gender, data = givings)
t(t8)
t(round(t8/rowSums(t8),2))
t9 <- xtabs(~ Major.Donation.Level + AttendenceEvent, data = givings)
t(t9)
t(round(t9/rowSums(t9),2))
t10 <- xtabs(~ Class.Year + AttendenceEvent, data = givings)
t(t10)
t(round(t10/rowSums(t10),2))
t11 <- xtabs(~ Class.Year + FY16Giving.Grouped + Gender, data = givings)
t11
t11 <- xtabs(~ Major.Donation.Level + FY16Giving.Grouped + Gender, data = givings)
t11
givings$Married <- factor(ifelse(givings$Marital.Status == "Married", TRUE,FALSE))
givings$Class.Year = as.numeric(givings$Class.Year)
model_B1a <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped, data = givings, link="logit")
Anova(model_B1a)
AIC(model_B1a)
#our original model based on including all variables that seemed related to FY16Giving.Grouped in EDA
model_B1g <- clm(formula = FY16Giving.Grouped~Class.Year + Married + AttendenceEvent + FY15Giving.Grouped + Major.Donation.Level + Adv.Deg+Gender+FY14Giving.Grouped + FY13Giving.Grouped + FY12Giving.Grouped,data =givings, link ="logit")
Anova(model_B1g)
anova(model_B1a, model_B1g)
#remove Class.Year as including it causes poor predictions due to high collinearity with FYGiving.Grouped variables
model_B1j <- clm(formula = FY16Giving.Grouped~Married + AttendenceEvent+FY15Giving.Grouped+Major.Donation.Level+Adv.Deg+Gender+FY14Giving.Grouped+FY13Giving.Grouped+FY12Giving.Grouped,data =givings, link ="logit")
summary(model_B1j)
Anova(model_B1j)
anova(model_B1j,model_B1a)
model_B1a <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped, data = givings, link="logit")
Anova(model_B1a)
#add gender
model_B1b <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped+Class.Year, data = givings, link="logit")
Anova(model_B1b)
anova(model_B1a,model_B1b)
#add marital status
model_B1c <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped+Marital.Status, data = givings, link="logit")
Anova(model_B1c)
anova(model_B1a,model_B1c)
#add attend event
model_B1d <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped+AttendenceEvent, data = givings, link="logit")
Anova(model_B1d)
anova(model_B1a,model_B1d)
#add major
model_B1e <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped + Major.Donation.Level, data = givings, link="logit")
Anova(model_B1e)
anova(model_B1a,model_B1e)
#add advance degree
model_B1x <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped + Adv.Deg, data = givings, link="logit")
Anova(model_B1x)
anova(model_B1a,model_B1x)
#add gender
model_B1y <- clm(formula= FY16Giving.Grouped ~ FY15Giving.Grouped + Gender, data = givings, link="logit")
Anova(model_B1y)
anova(model_B1a,model_B1y)
#add all above variables but not previous years' donation
model_B1f <- clm(formula = FY16Giving.Grouped~Class.Year +Marital.Status + AttendenceEvent+FY15Giving.Grouped+Major.Donation.Level+Adv.Deg+Gender,data =givings, link ="logit")
Anova(model_B1f)
anova(model_B1a,model_B1f)
#add previous years' donation
model_B1h <- clm(formula = FY16Giving.Grouped~FY15Giving.Grouped+FY14Giving.Grouped+FY13Giving.Grouped+FY12Giving.Grouped,data =givings, link ="logit")
Anova(model_B1h)
anova(model_B1a,model_B1h)
#add all variables
model_B1g <- clm(formula = FY16Giving.Grouped~Class.Year +Marital.Status + AttendenceEvent+FY15Giving.Grouped+Major.Donation.Level+Adv.Deg+Gender+FY14Giving.Grouped+FY13Giving.Grouped+FY12Giving.Grouped,data =givings, link ="logit")
Anova(model_B1g)
anova(model_B1h,model_B1g)
#add all variables
model_B1j <- clm(formula = FY16Giving.Grouped~Married + AttendenceEvent+FY15Giving.Grouped+Major.Donation.Level+Adv.Deg+Gender+FY14Giving.Grouped+FY13Giving.Grouped+FY12Giving.Grouped,data =givings, link ="logit")
summary(model_B1j)
Anova(model_B1j)
anova(model_B1j,model_B1g)
conf.beta <- confint(object = model_B1j , level = 0.95)
conf.beta <- as.data.frame.matrix(conf.beta)
conf.beta[,3]<-model_B1j$coefficients[5:28];colnames(conf.beta)[3] = "estimated"
round(conf.beta,2)
round(exp(conf.beta),2)
c1 <- xtabs(~Gender+FY16Giving.Grouped, data=givings)
c2 <- xtabs(~Marital.Status+FY16Giving.Grouped, data=givings)
c3 <- xtabs(~Class.Year+FY16Giving.Grouped, data=givings)
c4 <- xtabs(~Major.Donation.Level+FY16Giving.Grouped, data=givings)
c5 <- xtabs(~AttendenceEvent+FY16Giving.Grouped, data=givings)
odds_ratio <- function(r1){
df1 <- as.data.frame.matrix(r1)
n <- dim(df1)[1]
len <- dim(df1)[2]
odds = data.frame(matrix(0, n, len-1))
colnames(odds) <- colnames(df1)[1:len-1]
for( i in seq(1,len-1)){
if(i==1) {
lowerp <- df1[,1]
}else {
lowerp <- rowSums(df1[,1:i])
}
if(i==len-1) {
upperp <- df1[,len]
} else {
upperp<-rowSums(df1[,(i+1):len])
}
odds[,i] <- lowerp/upperp
}
round(odds,2)
oratio <- data.frame(matrix(0, n-1, len-1),row.names = rownames(df1)[2:n])
colnames(oratio)<- colnames(odds)
for(j in seq(1,n-1)) oratio[j,] <- odds[j+1,]/odds[j,]
return(round(oratio,2))
}
#Gender
odds_ratio(c1)
#Marital Status
odds_ratio(c2)
#Graduating class
odds_ratio(c3)
#Major
odds_ratio(c4)
#Addent Event
odds_ratio(c5)
model_B1j <- clm(formula = FY16Giving.Grouped ~ Married + Adv.Deg + Gender + AttendenceEvent + High.Donor.Major + FY15Giving.Grouped + FY14Giving.Grouped +FY13Giving.Grouped + FY12Giving.Grouped, data =givings, link ="logit")
Anova(model_B1j)
## model_polr = polr(formula = FY16Giving.Grouped ~ Married + Adv.Deg + Gender + AttendenceEvent + High.Donor.Major + FY15Giving.Grouped + FY14Giving.Grouped +FY13Giving.Grouped + FY12Giving.Grouped, data =givings, method ="logistic")
## conf.beta = confint(object = model_polr, level = 0.95)
## ci.ord = exp(conf.beta) # inverted coefficients to assess responses at or ABOVE a certain level
## round(data.frame(low = ci.ord[,2], up = ci.ord[,1]), 2)
conf.beta <- confint(object = model_B1j , level = 0.95)
conf.beta <- as.data.frame.matrix(conf.beta)
conf.beta[,3]<-model_B1j$coefficients[5:26];colnames(conf.beta)[3] = "estimated"
round(conf.beta,2)
round(exp(conf.beta),2)
#explanatory variables
var.list <- c("Married","AttendenceEvent","FY15Giving.Grouped","Major.Donation.Level","Adv.Deg","Gender","FY14Giving.Grouped","FY13Giving.Grouped","FY12Giving.Grouped")
pred.list<-c("[0-1)","[1-100)","[100-250)","[250-500)","[500-200000)" )
newData <- unique(givings[,var.list])
predicts<-cbind(newData, predict(model_B1j, newdata=newData)$fit)
